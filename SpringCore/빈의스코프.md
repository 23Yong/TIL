# 빈의 스코프(Scope)

## 스코프

우리가 등록한 빈들은 스코프라는 것이 있다. 아무런 설정을 하지 않으면 빈의 스코프는 자동적으로 싱글톤 스코프를 가진다. 싱글톤 스코프의 빈은 애플리케이션 전반에 걸쳐서 빈이 하나만 생성이 된다고 생각하면 된다.

싱글톤이 아닌 프로토타입의 빈이 존재하는데, 이는 빈을 받아올 떄마다 새로운 인스턴스가 생성이 되는 것이다.
프로토타입 스코프의 빈은 @Scope("prototype") 어노테이션을 달아 사용을 할 수 있다.

이것들 말고도 request, session, application, websocket이 존재한다.

## 싱긑톤 스코프의 빈이 프로토타입 스코프의 빈 참조

프로토타입의 빈이 싱글톤 빈을 참조하는 것은 아무문제가 없다. 하지만 싱글톤 스코프에 있는 프로토타입의 빈은 제대로 동작하지 않는다. 싱글톤 타입의 빈은 인스턴스가 한 번만 생성이 되기 때문에 그 안에 있는 프로토타입의 빈도 한 번만 생성이 되어서 우리가 의도한대로 동작하지 않는다.

### 해결방법
위의 문제를 우리가 의도한대로 사용하려면 다음과 같이 하면 된다. 빈으로 등록할 것이 클래스일 경우에는
- @Scope("prototype", proxyMode=ScopedProxyMode.TARGET_CLASS)

위의 어노테이션을 프로토타입의 스코프로 설정할 빈 클래스 위에 달아준다. 이렇게 클래스에 적용할 경우에는 CGlib를 사용한 다이내믹 프록시가 적용이된다.

물론 인터페이스라면 TARGET_INTERFACES를 사용하면되고 이때는 JDK에 있는 인터페이스기반의 프록시가 사용될 것이댜.

### 어떻게 동작하는 걸까
어노테이션에 붙은 proxyMode가 다른 인스턴스의 빈들이 이 빈을 직접 참조하지 않고 프록시를 거쳐서 참조하게 해주기 위해서 "해당 빈을 프록시로 감싸라"라고 알려준다.

매번 빈을 바꾸어주어야 하는데, 해당 빈을 직접 쓰게 되면 바꿔줄 여지가 없기 때문에 프록시로 감싸 매번 바꿀 수 있도록 해준다.

## 싱글톤 타입의 빈을 사용시 주의할 점
- 프로퍼티가 공유된다. 싱글톤 빈이 어떤 데이터를 가지고 있다고 할 때 thread-safe하다고 보장받을 수 없다. 여러 thread에서 같은 곳을 바라보고 있기 때문에 항상 주의해야 한다.
- ApplicationContext 초기 구동시 인스턴스가 생성이 된다. 그래서 애플리케이션을 구동할 때 시간이 좀 더 걸릴 수 있다.

## 참고자료
[스프링 프레임워크 핵심 기술](https://www.inflearn.com/course/spring-framework_core/dashboard)
